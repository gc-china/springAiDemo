# æ–‡ä»¶çº§ä¸åˆ‡ç‰‡çº§åŒé‡å»é‡ï¼šæ„å»ºå¹‚ç­‰çŸ¥è¯†åº“

## 1. èƒŒæ™¯ä¸ç—›ç‚¹

åœ¨ RAG ç³»ç»Ÿçš„æ–‡æ¡£æ‘„å…¥ï¼ˆIngestionï¼‰æµç¨‹ä¸­ï¼Œé‡å¤æ•°æ®æ˜¯æˆæœ¬å’Œæ€§èƒ½çš„æ€æ‰‹ã€‚æˆ‘ä»¬éœ€è¦è§£å†³ä¸¤ä¸ªå±‚é¢çš„é—®é¢˜ï¼š

1. **å®Œå…¨é‡å¤ä¸Šä¼ **ï¼šç”¨æˆ·è¯¯ä¼ äº†åŒä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ–è€…å¤šäººä¸Šä¼ äº†åŒä¸€ä»½èµ„æ–™ã€‚
2. **éƒ¨åˆ†å†…å®¹å†—ä½™**ï¼šä¸åŒæ–‡æ¡£ä¸­åŒ…å«ç›¸åŒçš„æ®µè½ï¼ˆå¦‚å…¬å¸çš„â€œå…è´£å£°æ˜â€ï¼‰ï¼Œæˆ–è€…æ–‡æ¡£åªä¿®æ”¹äº†å‡ ä¸ªå­—é‡æ–°ä¸Šä¼ ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæ„å»º **â€œåŒé‡å»é‡é˜²å¾¡ä½“ç³»â€**ã€‚

* **ç¬¬ä¸€é“é˜²çº¿ï¼ˆæ–‡ä»¶çº§ï¼‰**ï¼šç§’çº§æ‹¦æˆªå®Œå…¨é‡å¤çš„æ–‡ä»¶ï¼ŒèŠ‚çœè§£æè®¡ç®—èµ„æºã€‚
* **ç¬¬äºŒé“é˜²çº¿ï¼ˆåˆ‡ç‰‡çº§ï¼‰**ï¼šç²¾å‡†è¿‡æ»¤é‡å¤æ®µè½ï¼ŒèŠ‚çœå‘é‡å­˜å‚¨å’Œ Embedding æˆæœ¬ã€‚

---

## 2. ç¬¬ä¸€é“é˜²çº¿ï¼šæ–‡ä»¶çº§å»é‡ (File-Level)

**ç›®æ ‡**ï¼šåœ¨è°ƒç”¨æ˜‚è´µçš„ Tika è§£æå™¨ä¹‹å‰ï¼Œç›´æ¥æ‹¦æˆªé‡å¤æ–‡ä»¶ã€‚

* **æŒ‡çº¹ç®—æ³•**ï¼š**MD5**ã€‚è®¡ç®—æ•´ä¸ªæ–‡ä»¶çš„äºŒè¿›åˆ¶æŒ‡çº¹ã€‚
* **å­˜å‚¨ä½ç½®**ï¼šå…³ç³»å‹æ•°æ®åº“è¡¨ `document_file`ã€‚
* **æ‰§è¡Œæ—¶æœº**ï¼š`IngestionConsumer` æ”¶åˆ°æ¶ˆæ¯åï¼Œè§£ææ–‡æ¡£å‰ã€‚

### 2.1 æ•°æ®åº“è®¾è®¡ (`document_file`)

```sql
CREATE TABLE document_file (
    id VARCHAR(64) PRIMARY KEY,
    file_hash VARCHAR(64) NOT NULL, -- MD5 å€¼
    filename VARCHAR(255),
    file_size BIGINT,
    status VARCHAR(20),             -- COMPLETED, FAILED
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- å…³é”®ç´¢å¼•ï¼šåŠ é€ŸæŸ¥è¯¢
CREATE INDEX idx_document_file_hash ON document_file(file_hash);
```

### 2.2 æ‹¦æˆªé€»è¾‘

```java
// ä¼ªä»£ç é€»è¾‘
String fileMd5 = HashUtils.getFileMd5(filePath);
boolean exists = documentFileMapper.exists(new LambdaQueryWrapper<DocumentFile>()
        .eq(DocumentFile::getFileHash, fileMd5)
        .eq(DocumentFile::getStatus, "COMPLETED")); // ä»…æ‹¦æˆªå·²æˆåŠŸå¤„ç†çš„æ–‡ä»¶

if (exists) {
    logger.info("æ–‡ä»¶çº§å»é‡å‘½ä¸­: {}", filePath);
    return; // ç›´æ¥ç»“æŸï¼Œä¸è¿›è¡Œ Tika è§£æ
}
```

---

## 3. ç¬¬äºŒé“é˜²çº¿ï¼šåˆ‡ç‰‡çº§å»é‡ (Chunk-Level)

**ç›®æ ‡**ï¼šåœ¨è°ƒç”¨ Embedding API ä¹‹å‰ï¼Œè¿‡æ»¤æ‰å†…å®¹å®Œå…¨ä¸€è‡´çš„æ–‡æœ¬æ®µè½ã€‚

* **æŒ‡çº¹ç®—æ³•**ï¼š**SHA-256**ã€‚è®¡ç®—åˆ‡ç‰‡æ–‡æœ¬å†…å®¹çš„å“ˆå¸Œã€‚
* **å­˜å‚¨ä½ç½®**ï¼šå‘é‡æ•°æ®åº“ `vector_store` çš„ `metadata` (JSONB) å­—æ®µä¸­ï¼ŒKey ä¸º `chunk_hash`ã€‚
* **æ‰§è¡Œæ—¶æœº**ï¼š`KnowledgeBaseService` å…¥åº“å‰ã€‚

### 3.1 æµç¨‹å›¾è§£

```mermaid
graph TD
    Start[æ–‡æ¡£è§£æå®Œæˆ] --> Split[æ™ºèƒ½åˆ‡ç‰‡]
    Split --> CalcHash[è®¡ç®—æ¯ä¸ªåˆ‡ç‰‡çš„ SHA-256]
    
    CalcHash --> QueryVectorDB[æ‰¹é‡æŸ¥è¯¢ vector_store]
    QueryVectorDB -->|Hashå·²å­˜åœ¨| Filter[ğŸ—‘ï¸ è¿‡æ»¤ä¸¢å¼ƒ]
    QueryVectorDB -->|Hashä¸å­˜åœ¨| Keep[âœ… ä¿ç•™]
    
    Keep --> Embed[è°ƒç”¨ Embedding API]
    Embed --> Insert[å†™å…¥ vector_store & document_chunk]
```

---

## 3. å…³é”®æŠ€æœ¯å®ç°

### 3.1 æ•°æ®åº“è®¾è®¡ (`document_file`)

æˆ‘ä»¬éœ€è¦ä¸€å¼ è¡¨æ¥â€œè®°ä½â€å¤„ç†è¿‡çš„æ–‡ä»¶ã€‚

```sql
CREATE TABLE document_file (
    id VARCHAR(64) PRIMARY KEY,
    file_hash VARCHAR(64) NOT NULL, -- MD5 å€¼
    filename VARCHAR(255),
    status VARCHAR(20),             -- COMPLETED, FAILED
    create_time TIMESTAMP
);
-- å…³é”®ç´¢å¼•ï¼šåŠ é€ŸæŸ¥è¯¢
CREATE INDEX idx_document_file_hash ON document_file(file_hash);
```

### 3.2 å“ˆå¸Œè®¡ç®—å·¥å…· (`HashUtils`)

ä½¿ç”¨ Java æµå¼è¯»å–è®¡ç®— MD5ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§æ–‡ä»¶å¯¼è‡´å†…å­˜æº¢å‡º (OOM)ã€‚

```java
public static String getFileMd5(String filePath) {
    try (InputStream fis = new FileInputStream(filePath)) {
        MessageDigest digest = MessageDigest.getInstance("MD5");
        byte[] buffer = new byte[8192]; // 8KB ç¼“å†²åŒº
        int n;
        while ((n = fis.read(buffer)) != -1) {
            digest.update(buffer, 0, n);
        }
        // ... è½¬åå…­è¿›åˆ¶å­—ç¬¦ä¸²
        return hexString.toString();
    }
}
```

### 3.3 æ¶ˆè´¹è€…é›†æˆ (`IngestionConsumer`)

åœ¨è°ƒç”¨ Tika è§£æå™¨ä¹‹å‰ï¼Œå…ˆæŸ¥åº“ã€‚

```java
// 1. è®¡ç®—æŒ‡çº¹
String fileMd5 = HashUtils.getFileMd5(filePath);

// 2. æŸ¥åº“ (åªæ‹¦æˆªçŠ¶æ€ä¸º COMPLETED çš„ï¼Œé˜²æ­¢æ‹¦æˆªä¹‹å‰å¤±è´¥çš„ä»»åŠ¡)
boolean exists = documentFileMapper.exists(new LambdaQueryWrapper<DocumentFile>()
        .eq(DocumentFile::getFileHash, fileMd5)
        .eq(DocumentFile::getStatus, "COMPLETED"));

if (exists) {
    logger.info("æ–‡ä»¶çº§å»é‡å‘½ä¸­: {}", filePath);
    updateStatus(ingestionId, COMPLETED, 100, "æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†");
    return; // ç›´æ¥ç»“æŸ
}
```

---

## 4. æ€»ç»“

ç»“åˆä¹‹å‰çš„ **chunk_hash**ï¼Œæˆ‘ä»¬æ„å»ºäº† **åŒé‡å»é‡é˜²å¾¡ä½“ç³»**ï¼š

1. **æ–‡ä»¶çº§å»é‡ (MD5)**ï¼šç²—ç²’åº¦ã€ä½æˆæœ¬ã€‚æ‹¦æˆª 100% é‡å¤çš„æ–‡ä»¶ï¼ŒèŠ‚çœè§£æèµ„æºã€‚
2. **åˆ‡ç‰‡çº§å»é‡ (SHA-256)**ï¼šç»†ç²’åº¦ã€é«˜ç²¾åº¦ã€‚æ‹¦æˆªéƒ¨åˆ†ä¿®æ”¹çš„æ–‡ä»¶ï¼ŒèŠ‚çœå‘é‡å­˜å‚¨ç©ºé—´ã€‚

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2024-05-21*