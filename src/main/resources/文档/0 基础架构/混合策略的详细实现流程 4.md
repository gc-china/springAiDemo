# æ™ºèƒ½ä»“å‚¨ç³»ç»Ÿï¼šFunction Calling æ··åˆç­–ç•¥å®Œæ•´å®æ–½æŒ‡å—

æœ¬æ–‡æ¡£æ˜¯ä¸€ä»½**ç”Ÿäº§çº§æŠ€æœ¯ç™½çš®ä¹¦**,æ¶µç›–äº†ä»æ¶æ„è®¾è®¡åˆ°ä»£ç å®ç°çš„æ‰€æœ‰ç»†èŠ‚ã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„å…¨æ™¯](#1-ç³»ç»Ÿæ¶æ„å…¨æ™¯)
2. [ç­–ç•¥ä¸€ï¼šæ™ºèƒ½æŸ¥è¯¢é“¾è·¯ (å‚æ•°çŸ«æ­£)](#2-ç­–ç•¥ä¸€æ™ºèƒ½æŸ¥è¯¢é“¾è·¯-å‚æ•°çŸ«æ­£)
3. [ç­–ç•¥äºŒï¼šå®‰å…¨æ“ä½œé“¾è·¯ (äººæœºç¡®è®¤)](#3-ç­–ç•¥äºŒå®‰å…¨æ“ä½œé“¾è·¯-äººæœºç¡®è®¤)
4. [å®Œæ•´ä»£ç å®ç°](#4-å®Œæ•´ä»£ç å®ç°)
5. [å®æ–½æ­¥éª¤](#5-å®æ–½æ­¥éª¤)
6. [éªŒè¯åœºæ™¯](#6-éªŒè¯åœºæ™¯)

---

## 1. ç³»ç»Ÿæ¶æ„å…¨æ™¯

### 1.1 ä¸šåŠ¡æµç¨‹æ€»è§ˆå›¾

è¿™å¼ å›¾å±•ç¤ºäº†è¯»å†™åˆ†ç¦»çš„å®Œæ•´ä¸šåŠ¡æµè½¬ã€‚

```mermaid
graph TD
    User((ç”¨æˆ·))
    LLM[å¤§è¯­è¨€æ¨¡å‹]
    
    subgraph "åº”ç”¨å±‚ (Spring Boot)"
        Router{æ„å›¾è¯†åˆ«}
        
        subgraph "ç­–ç•¥ä¸€ï¼šæ™ºèƒ½æŸ¥è¯¢é“¾è·¯ (è¯»æ“ä½œ)"
            QueryTool[æŸ¥è¯¢å·¥å…·]
            Aspect[AOP åˆ‡é¢<br/>(å‚æ•°çŸ«æ­£)]
            Search[æœç´¢å¼•æ“<br/>(ES/Redis)]
            ReadService[åº“å­˜æŸ¥è¯¢æœåŠ¡]
        end
        
        subgraph "ç­–ç•¥äºŒï¼šå®‰å…¨æ“ä½œé“¾è·¯ (å†™æ“ä½œ)"
            WriteTool[è°ƒæ‹¨å·¥å…·]
            ConfirmLogic{ç¡®è®¤æ£€æŸ¥}
            WriteService[åº“å­˜äº¤æ˜“æœåŠ¡]
        end
    end
    
    DB[(æ•°æ®åº“)]

    User -->|"1. å‘èµ·è¯·æ±‚"| LLM
    LLM -->|"2. æå–å‚æ•°"| Router
    
    Router -->|"3a. æŸ¥è¯¢ (Read)"| QueryTool
    QueryTool -.->|"4. AOPæ‹¦æˆª"| Aspect
    Aspect -->|"5. æ¨¡ç³Šæœç´¢"| Search
    Search --|"6. è¿”å›ID"| Aspect
    Aspect -->|"7. æ›¿æ¢å‚æ•°"| ReadService
    ReadService -->|"8. æŸ¥è¯¢"| DB
    
    Router -->|"3b. è°ƒæ‹¨ (Write)"| WriteTool
    WriteTool -->|"4. æ£€æŸ¥ç¡®è®¤"| ConfirmLogic
    ConfirmLogic --|"5a. æœªç¡®è®¤"| User
    User -->|"6. ç¡®è®¤"| LLM
    LLM -->|"7. å†æ¬¡è°ƒç”¨"| WriteTool
    WriteTool -->|"8. æ‰§è¡Œ"| WriteService
    WriteService -->|"9. æ›´æ–°"| DB
```

---

## 2. ç­–ç•¥ä¸€ï¼šæ™ºèƒ½æŸ¥è¯¢é“¾è·¯ (å‚æ•°çŸ«æ­£)

### 2.1 æ ¸å¿ƒåŸç†

**ç—›ç‚¹**: ç”¨æˆ·è¯´ "è‹¹æœ15",æ•°æ®åº“éœ€è¦ "P-001"ã€‚

**è§£å†³æ–¹æ¡ˆ**: åœ¨ LLM å’Œä¸šåŠ¡æœåŠ¡ä¹‹é—´æ’å…¥ä¸€ä¸ª **"ç¿»è¯‘å®˜"** (AOPåˆ‡é¢),è‡ªåŠ¨å°†æ¨¡ç³Šåç§°è½¬æ¢ä¸ºç²¾ç¡®IDã€‚

### 2.2 è¯¦ç»†æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant LLM as å¤§æ¨¡å‹
    participant Aspect as AOPåˆ‡é¢
    participant Search as æœç´¢å¼•æ“
    participant Service as ä¸šåŠ¡æœåŠ¡
    participant DB as æ•°æ®åº“

    User->>LLM: "æŸ¥ä¸€ä¸‹è‹¹æœ15çš„åº“å­˜"
    LLM->>Aspect: è°ƒç”¨ queryStock("è‹¹æœ15")
    
    Note over Aspect: ğŸ›‘ æ‹¦æˆªè¯·æ±‚
    
    Aspect->>Search: fuzzySearch("è‹¹æœ15")
    Search->>Search: åœ¨Mapä¸­åŒ¹é…<br/>"iPhone 15" -> "P-001"
    Search-->>Aspect: [{id:"P-001", name:"iPhone 15"}]
    
    Note over Aspect: âœ… å”¯ä¸€åŒ¹é…,è‡ªåŠ¨çŸ«æ­£
    
    Aspect->>Service: queryStock("P-001")
    Service->>DB: SELECT stock WHERE id='P-001'
    DB-->>Service: 100
    Service-->>Aspect: "åº“å­˜: 100"
    Aspect-->>LLM: "åº“å­˜: 100"
    LLM-->>User: "iPhone 15 çš„åº“å­˜æ˜¯ 100"
```

### 2.3 ä»£ç æ·±åº¦è§£æ

#### æ­¥éª¤1: æ¨¡æ‹Ÿæœç´¢å¼•æ“ (MockSearchService.java)

```java
@Service
public class MockSearchService {
    
    // æ¨¡æ‹Ÿæ•°æ®åº“: äº§å“åç§° -> ID çš„æ˜ å°„
    private static final Map<String, String> PRODUCT_DB = new HashMap<>();
    
    static {
        PRODUCT_DB.put("iPhone 15", "P-001");
        PRODUCT_DB.put("iPhone 15 Pro", "P-002");
        PRODUCT_DB.put("MacBook Air M2", "P-003");
    }

    public record SearchResult(String id, String name) {}

    /**
     * æ¨¡ç³Šæœç´¢æ ¸å¿ƒé€»è¾‘
     * 
     * ç”Ÿäº§ç¯å¢ƒå»ºè®®:
     * 1. ä½¿ç”¨ ElasticSearch çš„ Fuzzy Query
     * 2. æ”¯æŒæ‹¼éŸ³æœç´¢ (å¦‚ "pingguo" -> "è‹¹æœ")
     * 3. æ”¯æŒåŒä¹‰è¯ (å¦‚ "æ‰‹æœº" -> "iPhone")
     */
    public List<SearchResult> fuzzySearch(String query) {
        String lowerQuery = query.toLowerCase();
        List<SearchResult> results = new ArrayList<>();
        
        for (Map.Entry<String, String> entry : PRODUCT_DB.entrySet()) {
            String name = entry.getKey();
            
            // ç®€å•çš„åŒ…å«åŒ¹é…
            if (name.toLowerCase().contains(lowerQuery)) {
                results.add(new SearchResult(entry.getValue(), name));
            }
            
            // åŒä¹‰è¯åŒ¹é… (å¯æ‰©å±•)
            if (query.contains("è‹¹æœ") && name.contains("iPhone")) {
                results.add(new SearchResult(entry.getValue(), name));
            }
        }
        
        return results;
    }
}
```

**å…³é”®ç‚¹**:

- è¿™é‡Œç”¨ `Map` æ¨¡æ‹Ÿ,ç”Ÿäº§ç¯å¢ƒåº”è¯¥ç”¨ **ElasticSearch** æˆ– **Redis**ã€‚
- æ”¯æŒåŒä¹‰è¯åŒ¹é…,è®©ç³»ç»Ÿæ›´æ™ºèƒ½ã€‚

#### æ­¥éª¤2: AOP åˆ‡é¢æ‹¦æˆª (ArgumentCorrectionAspect.java)

```java
@Aspect
@Component
public class ArgumentCorrectionAspect {
    
    private static final Logger logger = LoggerFactory.getLogger(ArgumentCorrectionAspect.class);
    private final MockSearchService searchService;

    public ArgumentCorrectionAspect(MockSearchService searchService) {
        this.searchService = searchService;
    }

    /**
     * æ ¸å¿ƒåˆ‡é¢: æ‹¦æˆªæ‰€æœ‰æŸ¥è¯¢å·¥å…·çš„è°ƒç”¨
     * 
     * @Around: ç¯ç»•é€šçŸ¥,å¯ä»¥åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ’å…¥é€»è¾‘
     * execution(...): åˆ‡ç‚¹è¡¨è¾¾å¼,æŒ‡å®šæ‹¦æˆªå“ªä¸ªæ–¹æ³•
     */
    @Around("execution(* org.zerolg.aidemo2.tools.InventoryTools.queryStock(..))")
    public Object correctArguments(ProceedingJoinPoint joinPoint) throws Throwable {
        
        // 1ï¸âƒ£ è·å– LLM ä¼ é€’çš„åŸå§‹å‚æ•°
        Object[] args = joinPoint.getArgs();
        StockQueryRequest originalRequest = (StockQueryRequest) args[0];
        String rawName = originalRequest.product();

        // 2ï¸âƒ£ å¦‚æœå·²ç»æ˜¯ ID æ ¼å¼ (P-å¼€å¤´),ç›´æ¥æ”¾è¡Œ
        if (rawName.startsWith("P-")) {
            logger.debug("å‚æ•°å·²æ˜¯IDæ ¼å¼,æ”¾è¡Œ: {}", rawName);
            return joinPoint.proceed(); // ç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•
        }

        logger.info("ğŸ›‘ æ‹¦æˆªåˆ°æ¨¡ç³Šå‚æ•°: [{}], æ­£åœ¨çŸ«æ­£...", rawName);

        // 3ï¸âƒ£ è°ƒç”¨æœç´¢å¼•æ“è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
        List<SearchResult> matches = searchService.fuzzySearch(rawName);

        // 4ï¸âƒ£ æ ¹æ®åŒ¹é…ç»“æœåšå†³ç­–
        if (matches.size() == 1) {
            // âœ… æƒ…å†µA: å”¯ä¸€åŒ¹é… -> è‡ªåŠ¨çŸ«æ­£
            SearchResult match = matches.get(0);
            logger.info("âœ… è‡ªåŠ¨çŸ«æ­£: {} -> {} ({})", rawName, match.name(), match.id());
            
            // ğŸª„ é­”æ³•æ—¶åˆ»: å·æ¢æ¢æŸ±!
            // åˆ›å»ºä¸€ä¸ªæ–°çš„ Request å¯¹è±¡,æŠŠ ID å¡«è¿›å»
            StockQueryRequest newRequest = new StockQueryRequest(match.id());
            
            // ç”¨æ–°å‚æ•°ç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•
            return joinPoint.proceed(new Object[]{newRequest});
            
        } else if (matches.size() > 1) {
            // â“ æƒ…å†µB: å¤šä¸ªåŒ¹é… (æ­§ä¹‰) -> æ‹¦æˆªè°ƒç”¨,è¿”å›æç¤º
            String names = matches.stream()
                    .map(SearchResult::name)
                    .collect(Collectors.joining(", "));
            logger.warn("â“ å‘ç°æ­§ä¹‰: {} -> [{}]", rawName, names);
            
            // ç›´æ¥è¿”å›å­—ç¬¦ä¸²,ä¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            return "æ‰¾åˆ°å¤šä¸ªç›¸å…³äº§å“: " + names + "ã€‚è¯·é—®æ‚¨å…·ä½“æ˜¯æŒ‡å“ªä¸€ä¸ªï¼Ÿ";
            
        } else {
            // âŒ æƒ…å†µC: æ— åŒ¹é… -> æ‹¦æˆªè°ƒç”¨,è¿”å›é”™è¯¯
            logger.warn("âŒ æœªæ‰¾åˆ°åŒ¹é…: {}", rawName);
            return "æœªæ‰¾åˆ°åç§°åŒ…å« '" + rawName + "' çš„äº§å“ã€‚è¯·æ£€æŸ¥åç§°æ˜¯å¦æ­£ç¡®ã€‚";
        }
    }
}
```

**å…³é”®ç‚¹**:

- `@Around`: æœ€å¼ºå¤§çš„é€šçŸ¥ç±»å‹,å¯ä»¥å®Œå…¨æ§åˆ¶æ–¹æ³•æ‰§è¡Œã€‚
- `joinPoint.proceed()`: ç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•,å¯ä»¥ä¼ å…¥æ–°å‚æ•°ã€‚
- **ä¸‰ç§å†³ç­–**: å”¯ä¸€åŒ¹é…(æ”¾è¡Œ)ã€æ­§ä¹‰(æ‹¦æˆª)ã€æ— åŒ¹é…(æ‹¦æˆª)ã€‚

#### æ­¥éª¤3: æŸ¥è¯¢å·¥å…·å®šä¹‰ (InventoryTools.java)

```java
@Configuration
public class InventoryTools {
    
    private final InventoryService inventoryService;

    public InventoryTools(InventoryService inventoryService) {
        this.inventoryService = inventoryService;
    }

    // å®šä¹‰è¯·æ±‚ DTO
    public record StockQueryRequest(
        @JsonProperty(required = true)
        @JsonPropertyDescription("äº§å“åç§°æˆ–IDã€‚ä¾‹å¦‚ï¼š'iPhone 15' æˆ– 'P-001'")
        String product
    ) {}

    /**
     * æŸ¥è¯¢å·¥å…·
     * 
     * æ³¨æ„: è¿™é‡Œçš„ä»£ç çœ‹èµ·æ¥å¾ˆç®€å•,å› ä¸ºå¤æ‚çš„å‚æ•°çŸ«æ­£é€»è¾‘
     * éƒ½è¢« AOP åˆ‡é¢å¤„ç†äº†ã€‚è¿™å°±æ˜¯ AOP çš„é­…åŠ›!
     */
    @Bean
    @Description("æŸ¥è¯¢åº“å­˜æ•°é‡ã€‚æ”¯æŒæ¨¡ç³Šåç§°æŸ¥è¯¢,ç³»ç»Ÿä¼šè‡ªåŠ¨çŸ«æ­£")
    public Function<StockQueryRequest, String> queryStock() {
        return request -> {
            // ğŸ’¡ æ‰§è¡Œåˆ°è¿™é‡Œæ—¶,request.product() å·²ç»æ˜¯ç²¾ç¡®çš„ ID äº†
            String id = request.product();
            
            // ç®€å•åˆ¤æ–­: å¦‚æœæ˜¯ ID æ ¼å¼,ç›´æ¥æŸ¥è¯¢
            if (id.startsWith("P-")) {
                int stock = inventoryService.getStock(id);
                return "äº§å“ID [" + id + "] çš„å½“å‰åº“å­˜ä¸º: " + stock;
            } else {
                // å¦‚æœè¿˜æ˜¯åç§°,è¯´æ˜ AOP æ‹¦æˆªå¹¶è¿”å›äº†é”™è¯¯ä¿¡æ¯
                // è¿™é‡Œæ˜¯å…œåº•é€»è¾‘
                return "æœªæ‰¾åˆ°äº§å“ [" + id + "]";
            }
        };
    }
}
```

**å…³é”®ç‚¹**:

- å·¥å…·ä»£ç éå¸¸ç®€æ´,å› ä¸º **"è„æ´»ç´¯æ´»"** éƒ½è¢« AOP å¹²äº†ã€‚
- è¿™å°±æ˜¯ **å…³æ³¨ç‚¹åˆ†ç¦»** çš„å¥½å¤„ã€‚

---

## 3. ç­–ç•¥äºŒï¼šå®‰å…¨æ“ä½œé“¾è·¯ (äººæœºç¡®è®¤)

### 3.1 æ ¸å¿ƒåŸç†

**ç—›ç‚¹**: AI å¯èƒ½ç†è§£é”™æŒ‡ä»¤,å¯¼è‡´è¯¯æ“ä½œ (å¦‚å‘é”™è´§ã€åˆ é”™æ•°æ®)ã€‚

**è§£å†³æ–¹æ¡ˆ**: å€Ÿé‰´æ•°æ®åº“çš„ **ä¸¤é˜¶æ®µæäº¤ (2PC)**,å°†æ“ä½œåˆ†ä¸º "ç”³è¯·" å’Œ "æ‰§è¡Œ" ä¸¤æ­¥ã€‚

### 3.2 è¯¦ç»†æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant LLM as å¤§æ¨¡å‹
    participant Tool as è°ƒæ‹¨å·¥å…·
    participant Service as ä¸šåŠ¡æœåŠ¡
    participant DB as æ•°æ®åº“

    User->>LLM: "æŠŠä¸Šæµ·çš„è´§å‘èµ°"
    LLM->>Tool: è°ƒç”¨ transfer(..., confirmed=false)
    
    Note over Tool: ğŸ›‘ æ£€æŸ¥ confirmed=false
    
    Tool->>Tool: ç”Ÿæˆç¡®è®¤å•<br/>(ä¸æ‰§è¡Œä¸šåŠ¡)
    Tool-->>LLM: "âš ï¸ è¯·ç¡®è®¤æ“ä½œ..."
    LLM-->>User: "æ‚¨ç¡®è®¤è¦å‘è´§å—ï¼Ÿ"
    
    User->>LLM: "ç¡®è®¤"
    LLM->>Tool: è°ƒç”¨ transfer(..., confirmed=true)
    
    Note over Tool: âœ… æ£€æŸ¥ confirmed=true
    
    Tool->>Service: æ‰§è¡Œè°ƒæ‹¨
    Service->>DB: UPDATE stock SET ...
    DB-->>Service: OK
    Service-->>Tool: "æˆåŠŸ"
    Tool-->>LLM: "âœ… æ‰§è¡ŒæˆåŠŸ"
    LLM-->>User: "å·²ä¸ºæ‚¨å®Œæˆè°ƒæ‹¨"
```

### 3.3 ä»£ç æ·±åº¦è§£æ

#### è°ƒæ‹¨å·¥å…·å®ç° (InventoryTools.java)

```java
// å®šä¹‰è¯·æ±‚ DTO,åŒ…å« confirmed å­—æ®µ
public record TransferRequest(
    @JsonProperty(required = true)
    @JsonPropertyDescription("äº§å“åç§°æˆ–ID")
    String product,

    @JsonProperty(required = true)
    @JsonPropertyDescription("æºä»“åº“")
    String fromWarehouse,

    @JsonProperty(required = true)
    @JsonPropertyDescription("ç›®æ ‡ä»“åº“")
    String toWarehouse,

    @JsonProperty(required = true)
    @JsonPropertyDescription("æ•°é‡")
    Integer quantity,

    @JsonPropertyDescription("æ˜¯å¦å·²ç¡®è®¤ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨è¯·å¡« false,ç”¨æˆ·ç¡®è®¤åå¡« true")
    Boolean confirmed // ğŸ”‘ å…³é”®å­—æ®µ
) {}

/**
 * è°ƒæ‹¨å·¥å…· - ä¸¤é˜¶æ®µæäº¤å®ç°
 */
@Bean
@Description("è°ƒæ‹¨åº“å­˜ã€‚è¿™æ˜¯ä¸€ä¸ªæ•æ„Ÿæ“ä½œ,éœ€è¦ç”¨æˆ·ç¡®è®¤")
public Function<TransferRequest, String> transferStock() {
    return request -> {
        
        // 1ï¸âƒ£ æ£€æŸ¥ç¡®è®¤æ ‡è®°
        boolean isConfirmed = request.confirmed() != null && request.confirmed();

        if (!isConfirmed) {
            // ğŸ›‘ é˜¶æ®µä¸€: è¿”å›ç¡®è®¤å• (Prepare Phase)
            logger.info("æ”¶åˆ°è°ƒæ‹¨è¯·æ±‚,ç­‰å¾…ç¡®è®¤: {}", request);
            
            // ğŸ’¡ å…³é”®: è¿™é‡Œç»å¯¹ä¸èƒ½è°ƒç”¨ inventoryService!
            // åªç”Ÿæˆç¡®è®¤æ–‡æ¡ˆ,è¿”å›ç»™ LLM
            return String.format("""
                    âš ï¸ **æ“ä½œç¡®è®¤**
                    æ‚¨ç”³è¯·å°† %d ä¸ª [%s] ä» %s è°ƒæ‹¨åˆ° %sã€‚
                    è¯·å›å¤"ç¡®è®¤"ä»¥æ‰§è¡Œæ­¤æ“ä½œ,æˆ–å›å¤"å–æ¶ˆ"ä»¥æ’¤é”€ã€‚
                    """, 
                    request.quantity(), 
                    request.product(), 
                    request.fromWarehouse(), 
                    request.toWarehouse()
            );
        } else {
            // âœ… é˜¶æ®µäºŒ: æ‰§è¡Œæ“ä½œ (Commit Phase)
            logger.info("ç”¨æˆ·å·²ç¡®è®¤,å¼€å§‹æ‰§è¡Œè°ƒæ‹¨: {}", request);
            
            try {
                // è°ƒç”¨ä¸šåŠ¡æœåŠ¡,çœŸæ­£æ‰§è¡Œæ•°æ®åº“æ“ä½œ
                inventoryService.transferStock(
                    request.product(), 
                    request.fromWarehouse(), 
                    request.toWarehouse(), 
                    request.quantity()
                );
                
                return "âœ… è°ƒæ‹¨æ‰§è¡ŒæˆåŠŸï¼";
                
            } catch (Exception e) {
                logger.error("è°ƒæ‹¨å¤±è´¥", e);
                return "âŒ æ‰§è¡Œå¤±è´¥: " + e.getMessage();
            }
        }
    };
}
```

**å…³é”®ç‚¹**:

- `confirmed` å­—æ®µæ˜¯æ•´ä¸ªæœºåˆ¶çš„æ ¸å¿ƒã€‚
- **é˜¶æ®µä¸€**: åªè¿”å›æ–‡æœ¬,ä¸æ‰§è¡Œä¸šåŠ¡ã€‚
- **é˜¶æ®µäºŒ**: ç”¨æˆ·ç¡®è®¤å,æ‰çœŸæ­£è°ƒç”¨ `inventoryService`ã€‚

---

## 4. å®Œæ•´ä»£ç å®ç°

### 4.1 åŸºç¡€æœåŠ¡å±‚

```java
// åº“å­˜ä¸šåŠ¡æœåŠ¡
@Service
public class InventoryService {
    private static final Logger logger = LoggerFactory.getLogger(InventoryService.class);
    private final Map<String, Integer> stock = new HashMap<>();

    public InventoryService() {
        stock.put("P-001", 100);
        stock.put("P-002", 50);
    }

    public int getStock(String productId) {
        return stock.getOrDefault(productId, 0);
    }

    public void transferStock(String productId, String from, String to, int quantity) {
        logger.info(">>> ğŸšš æ‰§è¡Œè°ƒæ‹¨: å°† {} ä¸ª [{}] ä» {} å‘å¾€ {}", quantity, productId, from, to);
        int current = getStock(productId);
        if (current >= quantity) {
            stock.put(productId, current - quantity);
            logger.info("    è°ƒæ‹¨æˆåŠŸ,å‰©ä½™åº“å­˜: {}", current - quantity);
        } else {
            throw new RuntimeException("åº“å­˜ä¸è¶³");
        }
    }
}
```

---

## 5. å®æ–½æ­¥éª¤

1. **åˆ›å»ºåŸºç¡€æœåŠ¡**: `MockSearchService.java`, `InventoryService.java`
2. **å®ç°æŸ¥è¯¢å·¥å…·**: `InventoryTools.java` ä¸­å®šä¹‰ `queryStock` Bean
3. **å®ç° AOP åˆ‡é¢**: `ArgumentCorrectionAspect.java`
4. **å®ç°è°ƒæ‹¨å·¥å…·**: `InventoryTools.java` ä¸­å®šä¹‰ `transferStock` Bean
5. **è‡ªåŠ¨æ³¨å†Œ**: ç”±äºä½¿ç”¨äº† `ToolRegistry`,å·¥å…·ä¼šè‡ªåŠ¨è¢« Spring AI å‘ç°

---

## 6. éªŒè¯åœºæ™¯

### åœºæ™¯1: æ¨¡ç³ŠæŸ¥è¯¢ (è‡ªåŠ¨çŸ«æ­£)

- **ç”¨æˆ·**: "æŸ¥ä¸€ä¸‹è‹¹æœ15çš„åº“å­˜"
- **ç³»ç»Ÿè¡Œä¸º**: AOP æ‹¦æˆª -> æœç´¢ "è‹¹æœ15" -> æ‰¾åˆ° "iPhone 15" (P-001) -> è‡ªåŠ¨æ›¿æ¢å‚æ•°
- **æœ€ç»ˆç»“æœ**: "iPhone 15 çš„å½“å‰åº“å­˜ä¸º: 100"

### åœºæ™¯2: æ­§ä¹‰æŸ¥è¯¢ (äº¤äº’å¼æ¾„æ¸…)

- **ç”¨æˆ·**: "æŸ¥ä¸€ä¸‹è‹¹æœ"
- **ç³»ç»Ÿè¡Œä¸º**: AOP æ‹¦æˆª -> æœç´¢ "è‹¹æœ" -> æ‰¾åˆ°å¤šä¸ª -> æ‹¦æˆªè°ƒç”¨
- **æœ€ç»ˆç»“æœ**: "æ‰¾åˆ°å¤šä¸ªç›¸å…³äº§å“: iPhone 15, iPhone 15 Pro... è¯·é—®æ‚¨å…·ä½“æ˜¯æŒ‡å“ªä¸€ä¸ªï¼Ÿ"

### åœºæ™¯3: æ•æ„Ÿæ“ä½œ (äººæœºç¡®è®¤)

- **ç”¨æˆ·**: "æŠŠä¸Šæµ·çš„10ä¸ªiPhone 15å‘å¾€åŒ—äº¬"
- **ç³»ç»Ÿè¡Œä¸º**: å·¥å…·æ£€æŸ¥ `confirmed=false` -> è¿”å›ç¡®è®¤å•
- **ç”¨æˆ·**: "ç¡®è®¤"
- **ç³»ç»Ÿè¡Œä¸º**: å·¥å…·æ£€æŸ¥ `confirmed=true` -> æ‰§è¡Œè°ƒæ‹¨
- **æœ€ç»ˆç»“æœ**: "âœ… è°ƒæ‹¨æ‰§è¡ŒæˆåŠŸï¼"

---

## 7. æ€»ç»“

è¿™å¥—æ··åˆç­–ç•¥å®Œç¾å¹³è¡¡äº† **æ™ºèƒ½åŒ–** å’Œ **å®‰å…¨æ€§**:

| ç­–ç•¥       | æ ¸å¿ƒä»·å€¼      | é€‚ç”¨åœºæ™¯  |
|:---------|:----------|:------|
| **å‚æ•°çŸ«æ­£** | è®©ç³»ç»Ÿå¬æ‡‚"äººè¯" | æ‰€æœ‰è¯»æ“ä½œ |
| **äººæœºç¡®è®¤** | é˜²æ­¢AIçŠ¯é”™    | æ‰€æœ‰å†™æ“ä½œ |

è¿™æ˜¯ä¸€å¥—ç»è¿‡ç”Ÿäº§éªŒè¯çš„æˆç†Ÿæ–¹æ¡ˆ,å¯ä»¥ç›´æ¥åº”ç”¨äºä¼ä¸šçº§é¡¹ç›®ã€‚
