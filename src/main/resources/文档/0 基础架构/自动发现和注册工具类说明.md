# å·¥å…·è‡ªåŠ¨å‘ç°å’Œæ³¨å†Œ - å®Œæ•´æµç¨‹è¯¦è§£

## ğŸ“Š æ‰§è¡Œæµç¨‹å›¾

```
Spring åº”ç”¨å¯åŠ¨
    â†“
1. Spring æ‰«ææ‰€æœ‰ @Configuration ç±»
    â†“
2. å‘ç° ProductService å’Œ UserService
    â†“
3. æ‰§è¡Œ @Bean æ–¹æ³•,åˆ›å»º Function Bean
    - getProductStock (Beanåç§°)
    - getUserInfo (Beanåç§°)
    â†“
4. å‘ç° ToolRegistry (@Configuration)
    â†“
5. æ‰§è¡Œ ToolRegistry.availableToolNames()
    â†“
6. é€šè¿‡ ApplicationContext è·å–æ‰€æœ‰ Function Bean
    â†“
7. è¿”å› List<String> = ["getProductStock", "getUserInfo"]
    â†“
8. Spring å°†è¿™ä¸ª List æ³¨å…¥åˆ°éœ€è¦çš„åœ°æ–¹
    â†“
9. AiService æ„é€ å‡½æ•°æ¥æ”¶ List<String> availableToolNames
    â†“
10. è½¬æ¢ä¸º String[] æ•°ç»„å­˜å‚¨
    â†“
11. ç”¨æˆ·è°ƒç”¨ processQuery()
    â†“
12. ä½¿ç”¨ .toolNames(availableTools) ä¼ é€’ç»™ ChatClient
```

---

## ğŸ” è¯¦ç»†ä»£ç æ‰§è¡Œæµç¨‹

### æ­¥éª¤1: å®šä¹‰å·¥å…· (ProductService.java)

```java
@Configuration  // â† Spring ä¼šæ‰«æè¿™ä¸ªç±»
public class ProductService {
    
    @Bean  // â† å‘Šè¯‰ Spring è¿™æ˜¯ä¸€ä¸ª Bean
    @Description("æŸ¥è¯¢åº“å­˜")  // â† AI ç”¨æ¥ç†è§£å·¥å…·ç”¨é€”
    public Function<String, Integer> getProductStock() {
        return (productName) -> {
            // å®é™…çš„ä¸šåŠ¡é€»è¾‘
            return 150;
        };
    }
}
```

**å…³é”®ç‚¹:**

- `@Bean` æ–¹æ³•å = Bean åç§° = "getProductStock"
- Spring ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•å¹¶ä¿å­˜è¿”å›çš„ Function
- è¿™ä¸ª Function ä¼šè¢« Spring AI æ¡†æ¶è¯†åˆ«ä¸º"å·¥å…·"

---

### æ­¥éª¤2: è‡ªåŠ¨æ‰«æå·¥å…· (ToolRegistry.java)

```java
@Configuration
public class ToolRegistry {
    
    @Autowired
    private ApplicationContext applicationContext;  // â† Spring å®¹å™¨
    
    @Bean  // â† è¿™ä¸ªæ–¹æ³•è¿”å›çš„ List ä¹Ÿæ˜¯ä¸€ä¸ª Bean
    public List<String> availableToolNames() {
        // 1ï¸âƒ£ ä» Spring å®¹å™¨è·å–æ‰€æœ‰ Function ç±»å‹çš„ Bean
        Map<String, Function> functionBeans = 
            applicationContext.getBeansOfType(Function.class);
        
        // å‡è®¾æ­¤æ—¶ functionBeans = {
        //   "getProductStock": Functionå®ä¾‹1,
        //   "getUserInfo": Functionå®ä¾‹2
        // }
        
        List<String> toolNames = new ArrayList<>();
        
        // 2ï¸âƒ£ éå†æ‰€æœ‰ Function Bean
        for (Map.Entry<String, Function> entry : functionBeans.entrySet()) {
            String beanName = entry.getKey();  // "getProductStock"
            toolNames.add(beanName);
        }
        
        // 3ï¸âƒ£ è¿”å›å·¥å…·åç§°åˆ—è¡¨
        // toolNames = ["getProductStock", "getUserInfo"]
        System.out.println(">>> è‡ªåŠ¨å‘ç°å·¥å…·: " + toolNames);
        return toolNames;
    }
}
```

**å…³é”®ç‚¹:**

- `applicationContext.getBeansOfType(Function.class)` æ˜¯æ ¸å¿ƒ
- å®ƒä¼šæ‰¾åˆ°æ‰€æœ‰ç±»å‹ä¸º `Function` çš„ Bean
- Bean çš„åç§°å°±æ˜¯å·¥å…·åç§°

---

### æ­¥éª¤3: æ³¨å…¥åˆ° AiService (AiService.java)

```java
@Service
public class AiService {
    
    private final String[] availableTools;
    
    // Spring ä¼šè‡ªåŠ¨æ³¨å…¥ List<String> availableToolNames
    public AiService(ChatClient chatClient, 
                     VectorStore vectorStore,
                     List<String> availableToolNames) {  // â† è‡ªåŠ¨æ³¨å…¥
        
        this.chatClient = chatClient;
        this.vectorStore = vectorStore;
        
        // å°† List è½¬æ¢ä¸ºæ•°ç»„
        this.availableTools = availableToolNames.toArray(new String[0]);
        // availableTools = ["getProductStock", "getUserInfo"]
        
        System.out.println(">>> åŠ è½½äº† " + availableTools.length + " ä¸ªå·¥å…·");
    }
    
    public Flux<String> processQuery(String msg) {
        return chatClient.prompt()
                .user(msg)
                .toolNames(availableTools)  // â† ä½¿ç”¨è‡ªåŠ¨å‘ç°çš„å·¥å…·
                .stream()
                .content();
    }
}
```

**å…³é”®ç‚¹:**

- Spring çœ‹åˆ°æ„é€ å‡½æ•°éœ€è¦ `List<String>` ç±»å‹çš„å‚æ•°
- Spring æ‰¾åˆ° `ToolRegistry.availableToolNames()` è¿”å›çš„ Bean
- è‡ªåŠ¨æ³¨å…¥è¿›æ¥

---

## ğŸ¯ ä¸‰ç§æ–¹å¼çš„å…³ç³»

### âŒ è¯¯è§£: ä¸‰ç§æ–¹å¼éœ€è¦åŒæ—¶å­˜åœ¨

### âœ… æ­£ç¡®: ä¸‰ç§æ–¹å¼æ˜¯**ä¸åŒçš„ä½¿ç”¨åœºæ™¯**,é€‰æ‹©ä¸€ç§å³å¯

è®©æˆ‘è¯¦ç»†è¯´æ˜:

### æ–¹å¼1: è‡ªåŠ¨åŠ è½½æ‰€æœ‰å·¥å…· (AiService.java)

```java
// é€‚ç”¨åœºæ™¯: æ‰€æœ‰æŸ¥è¯¢éƒ½éœ€è¦è®¿é—®æ‰€æœ‰å·¥å…·
public AiService(List<String> availableToolNames) {
    this.availableTools = availableToolNames.toArray(new String[0]);
}

public Flux<String> processQuery(String msg) {
    return chatClient.prompt()
            .toolNames(availableTools)  // æ¯æ¬¡éƒ½ç”¨æ‰€æœ‰å·¥å…·
            .stream()
            .content();
}
```

**ä½¿ç”¨åœºæ™¯:**

- å·¥å…·æ•°é‡ä¸å¤š (< 20ä¸ª)
- æ¯ä¸ªæŸ¥è¯¢éƒ½å¯èƒ½éœ€è¦ä»»ä½•å·¥å…·
- è¿½æ±‚ç®€å•,ä¸éœ€è¦ä¼˜åŒ–

---

### æ–¹å¼2: æŒ‰åˆ†ç±»ä½¿ç”¨ (æ‰‹åŠ¨é€‰æ‹©)

```java
@Autowired
private ToolCategories toolCategories;

public Flux<String> queryProducts(String msg) {
    // åªä½¿ç”¨äº§å“ç›¸å…³å·¥å…·
    String[] tools = toolCategories.getToolsArrayByCategories("product");
    
    return chatClient.prompt()
            .toolNames(tools)  // åªç”¨äº§å“å·¥å…·
            .stream()
            .content();
}

public Flux<String> queryUsers(String msg) {
    // åªä½¿ç”¨ç”¨æˆ·ç›¸å…³å·¥å…·
    String[] tools = toolCategories.getToolsArrayByCategories("user");
    
    return chatClient.prompt()
            .toolNames(tools)  // åªç”¨ç”¨æˆ·å·¥å…·
            .stream()
            .content();
}
```

**ä½¿ç”¨åœºæ™¯:**

- å·¥å…·å¾ˆå¤š (> 20ä¸ª)
- ä¸åŒæ¥å£éœ€è¦ä¸åŒå·¥å…·é›†
- éœ€è¦æ€§èƒ½ä¼˜åŒ–

---

### æ–¹å¼3: æ™ºèƒ½é€‰æ‹© (SmartAiService.java)

```java
public Flux<String> smartQuery(String msg) {
    // æ ¹æ®æŸ¥è¯¢å†…å®¹è‡ªåŠ¨é€‰æ‹©å·¥å…·
    String[] tools = selectToolsForQuery(msg);
    
    return chatClient.prompt()
            .toolNames(tools)  // åŠ¨æ€é€‰æ‹©çš„å·¥å…·
            .stream()
            .content();
}

private String[] selectToolsForQuery(String query) {
    if (query.contains("äº§å“")) {
        return toolCategories.getToolsArrayByCategories("product");
    } else if (query.contains("ç”¨æˆ·")) {
        return toolCategories.getToolsArrayByCategories("user");
    }
    return toolCategories.getAllToolsArray();
}
```

**ä½¿ç”¨åœºæ™¯:**

- å·¥å…·éå¸¸å¤š (> 50ä¸ª)
- å•ä¸€å…¥å£,éœ€è¦è‡ªåŠ¨åˆ¤æ–­
- è¿½æ±‚æœ€ä¼˜æ€§èƒ½

---

## ğŸ”§ å®é™…ä½¿ç”¨å»ºè®®

### å½“å‰ä½ çš„é¡¹ç›® (åªæœ‰2ä¸ªå·¥å…·)

**æ¨èä½¿ç”¨æ–¹å¼1** - æœ€ç®€å•:

```java
// å½“å‰çš„ AiService.java å°±æ˜¯è¿™æ ·å®ç°çš„
@Service
public class AiService {
    public AiService(List<String> availableToolNames) {
        this.availableTools = availableToolNames.toArray(new String[0]);
    }
    
    public Flux<String> processQuery(String msg) {
        return chatClient.prompt()
                .toolNames(availableTools)  // ä½¿ç”¨æ‰€æœ‰å·¥å…·
                .stream()
                .content();
    }
}
```

**ä½ åªéœ€è¦:**

1. ä¿ç•™ `ToolRegistry.java` (è‡ªåŠ¨æ‰«æ)
2. ä¿ç•™ `AiService.java` (ä½¿ç”¨æ‰€æœ‰å·¥å…·)
3. **åˆ é™¤** `SmartAiService.java` (æš‚æ—¶ä¸éœ€è¦)

---

### å¦‚æœå°†æ¥æœ‰100ä¸ªå·¥å…·

**å‡çº§åˆ°æ–¹å¼3**:

```java
@Service
public class AiService {
    private final ToolCategories toolCategories;
    
    public AiService(ToolCategories toolCategories) {
        this.toolCategories = toolCategories;
    }
    
    public Flux<String> processQuery(String msg) {
        // æ™ºèƒ½é€‰æ‹©å·¥å…·
        String[] tools = selectToolsForQuery(msg);
        
        return chatClient.prompt()
                .toolNames(tools)
                .stream()
                .content();
    }
}
```

---

## ğŸ“ æ€»ç»“

### è‡ªåŠ¨å‘ç°çš„æ ¸å¿ƒé€»è¾‘

```
1. Spring å¯åŠ¨æ—¶æ‰«ææ‰€æœ‰ @Bean æ–¹æ³•
2. ToolRegistry.availableToolNames() é€šè¿‡ ApplicationContext è·å–æ‰€æœ‰ Function Bean
3. è¿”å› Bean åç§°åˆ—è¡¨ ["getProductStock", "getUserInfo"]
4. Spring å°†è¿™ä¸ªåˆ—è¡¨æ³¨å…¥åˆ° AiService æ„é€ å‡½æ•°
5. AiService ä½¿ç”¨è¿™ä¸ªåˆ—è¡¨è°ƒç”¨ .toolNames()
```

### ä¸‰ç§æ–¹å¼çš„å…³ç³»

- **ä¸æ˜¯åŒæ—¶å­˜åœ¨**,è€Œæ˜¯**æ ¹æ®éœ€æ±‚é€‰æ‹©ä¸€ç§**
- éƒ½ä¾èµ– `ToolRegistry` çš„è‡ªåŠ¨æ‰«æåŠŸèƒ½
- åŒºåˆ«åœ¨äº**å¦‚ä½•ä½¿ç”¨**æ‰«æåˆ°çš„å·¥å…·åˆ—è¡¨

### å½“å‰æ¨è

**åªä¿ç•™æ–¹å¼1** (AiService.java):

- ç®€å•ç›´æ¥
- é€‚åˆä½ å½“å‰çš„2ä¸ªå·¥å…·
- è‡ªåŠ¨å‘ç°æ–°å·¥å…·,æ— éœ€ä¿®æ”¹ä»£ç 

éœ€è¦æˆ‘å¸®ä½ æ¸…ç†ä¸éœ€è¦çš„ä»£ç å—?
