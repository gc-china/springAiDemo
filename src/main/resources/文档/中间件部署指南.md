# 中间件部署指南

## 📦 当前项目使用的中间件清单

| 中间件 | 版本 | 用途 | Docker 镜像 | 端口 |
| :--- | :--- | :--- | :--- | :--- |
| **PostgreSQL + PGVector** | 16 | 关系型数据库 + 向量存储 | `pgvector/pgvector:pg16` | 5432 |
| **Redis** | 7.0 | 会话缓存 + Stream 队列 | `redis:7.0-alpine` | 6379 |
| **Redis Commander** | latest | Redis 可视化管理（可选） | `rediscommander/redis-commander` | 8081 |

---

## 🚀 一键启动所有服务

### 1. 启动基础设施
```bash
docker-compose up -d
```

### 2. 查看服务状态
```bash
docker-compose ps
```

预期输出：
```
NAME                    IMAGE                              STATUS
aidemo-pgvector         pgvector/pgvector:pg16            Up
aidemo-redis            redis:7.0-alpine                   Up
aidemo-redis-commander  rediscommander/redis-commander    Up
```

### 3. 查看日志
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f redis
docker-compose logs -f pgvector
```

---

## 🔧 验证服务可用性

### 验证 PostgreSQL
```bash
# 方式1: 使用 docker exec
docker exec -it aidemo-pgvector psql -U postgres -d aidemo

# 方式2: 使用 psql 客户端
psql -h localhost -p 5432 -U postgres -d aidemo
# 密码: postgres

# 验证 PGVector 扩展
\dx
# 应该能看到 vector 扩展

# 查看表
\dt
# 应该能看到 document, document_chunk, session_archives, vector_store
```

### 验证 Redis
```bash
# 方式1: 使用 docker exec
docker exec -it aidemo-redis redis-cli

# 方式2: 使用 redis-cli
redis-cli -h localhost -p 6379

# 测试连接
PING
# 应该返回 PONG

# 查看所有 Key
KEYS *
```

### 访问 Redis Commander (可视化工具)
打开浏览器访问: http://localhost:8081

---

## 🛑 停止服务

```bash
# 停止所有服务
docker-compose stop

# 停止并删除容器
docker-compose down

# 停止并删除容器 + 数据卷 (⚠️ 会删除所有数据)
docker-compose down -v
```

---

## 📂 数据持久化目录

项目根目录下会自动创建以下目录：
- `./pgdata`: PostgreSQL 数据文件
- `./redis-data`: Redis 持久化文件（AOF）
- `./init-scripts`: PostgreSQL 初始化脚本

**⚠️ 注意**: 这些目录已添加到 `.gitignore`，不会提交到 Git。

---

## 🔒 生产环境建议

### 1. 修改默认密码
编辑 `docker-compose.yml`，修改：
```yaml
environment:
  - POSTGRES_PASSWORD=your_strong_password
```

### 2. 配置 Redis 密码
在 `docker-compose.yml` 中为 Redis 添加密码：
```yaml
redis:
  command: redis-server --appendonly yes --requirepass your_redis_password
```

然后在 `application.yml` 中配置：
```yaml
spring:
  data:
    redis:
      password: your_redis_password
```

### 3. 网络隔离
当前已使用 `aidemo-network` 自定义网络，确保服务间通信安全。

---

## 📝 常见问题

### 1. 端口冲突
如果 5432 或 6379 端口被占用，修改 `docker-compose.yml`：
```yaml
ports:
  - "15432:5432"  # 修改宿主机端口
```

### 2. 权限问题（Windows）
确保 Docker Desktop 已启用 "文件共享"（Settings -> Resources -> File Sharing）。

### 3. 初始化脚本未执行
如果数据库表未创建，检查：
- `init-scripts/init.sql` 文件是否存在
- 删除 `./pgdata` 目录后重新启动（⚠️ 会清空数据）

---

**更新日期**: 2025-12-03
