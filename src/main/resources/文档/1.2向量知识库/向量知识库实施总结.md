# å‘é‡çŸ¥è¯†åº“ (PGVector) å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åŸºç¡€è®¾æ–½æ­å»º
- **Docker Compose**: é…ç½®äº† PostgreSQL 16 + PGVector é•œåƒ (`docker-compose.yml`)
- **åˆå§‹åŒ–è„šæœ¬**: åˆ›å»ºäº† `init.sql`ï¼ŒåŒ…å« `vector` æ‰©å±•å¯ç”¨å’Œè¡¨ç»“æ„åˆ›å»º
- **ä¾èµ–ç®¡ç†**: æ·»åŠ äº† `spring-ai-pgvector-store-spring-boot-starter` å’Œ `mybatis-plus`

### 2. æ•°æ®æ¨¡å‹è®¾è®¡ (Schema)

æˆ‘ä»¬é‡‡ç”¨äº† **åŒå±‚å­˜å‚¨æ¶æ„**ï¼š

#### 2.1 `document` è¡¨ (å…ƒæ•°æ®å±‚)
ç”¨äºå­˜å‚¨æ–‡æ¡£å±‚é¢çš„ä¿¡æ¯ï¼Œæ”¯æŒ CMS é£æ ¼çš„ç®¡ç†ã€‚
- `id`: UUID
- `title`, `source_url`, `file_path`: åŸºç¡€ä¿¡æ¯
- `metadata`: JSONB æ‰©å±•å­—æ®µ
- `total_tokens`, `chunk_count`: ç»Ÿè®¡ä¿¡æ¯

#### 2.2 `document_chunk` è¡¨ (åˆ‡ç‰‡å±‚)
ç”¨äºå­˜å‚¨åˆ‡åˆ†åçš„æ–‡æœ¬ï¼Œæ”¯æŒç²¾ç»†åŒ–å±•ç¤ºå’Œä¸Šä¸‹æ–‡å›æº¯ã€‚
- `document_id`: å…³è”çˆ¶æ–‡æ¡£
- `content`: åˆ‡ç‰‡æ–‡æœ¬
- `chunk_index`: é¡ºåºç´¢å¼•
- `metadata`: JSONB (åŒ…å«é¡µç ç­‰)
- **ç´¢å¼•**: `document_id` BTREE, `metadata` GIN

#### 2.3 `vector_store` è¡¨ (å‘é‡å±‚ - Spring AI é»˜è®¤)
ç”¨äºå®é™…çš„å‘é‡æ£€ç´¢ (RAG)ã€‚
- `embedding`: vector(1536)
- **ç´¢å¼•**: HNSW (Hierarchical Navigable Small World) é«˜æ€§èƒ½å‘é‡ç´¢å¼•

#### 2.4 `session_archives` è¡¨ (ä¼šè¯å½’æ¡£å±‚)
ç”¨äºå­˜å‚¨ä» Redis å½’æ¡£çš„å†å²ä¼šè¯äº‹ä»¶ (æ•´åˆè‡ªä¹‹å‰çš„ Session Archiving æ¨¡å—)ã€‚
- `conversation_id`: å…³è” Redis ä¼šè¯
- `payload`: JSONB å­˜å‚¨å®Œæ•´æ¶ˆæ¯å†…å®¹
- **ç´¢å¼•**: `conversation_id`, `timestamp`

### 3. æ ¸å¿ƒä»£ç å®ç°

#### 3.1 å®ä½“ä¸ Mapper
- `Document.java`, `DocumentChunk.java`: MyBatis Plus å®ä½“
- `DocumentMapper.java`, `DocumentChunkMapper.java`: æ•°æ®åº“æ“ä½œæ¥å£

#### 3.2 æ ¸å¿ƒæœåŠ¡
- **`DocumentSplitter.java`**:
  - å°è£… `TokenTextSplitter`
  - é»˜è®¤ 500 tokens åˆ‡ç‰‡ï¼Œ50 tokens é‡å 
- **`KnowledgeBaseService.java`**:
  - **Ingestion Pipeline**: 
    1. ä¿å­˜ Document å…ƒæ•°æ®
    2. åˆ‡åˆ†æ–‡æœ¬
    3. ä¿å­˜ DocumentChunk (ç”¨äºå±•ç¤º)
    4. è°ƒç”¨ Embedding Model ç”Ÿæˆå‘é‡
    5. ä¿å­˜åˆ° VectorStore (ç”¨äºæ£€ç´¢)
  - **äº‹åŠ¡ç®¡ç†**: `@Transactional` ä¿è¯æ•°æ®ä¸€è‡´æ€§

#### 3.3 æµ‹è¯•æ¥å£
- **`KnowledgeBaseController.java`**:
  - `POST /ai/knowledge/ingest`: æ‘„å…¥æ–‡æ¡£
  - `GET /ai/knowledge/search`: å‘é‡æ£€ç´¢

---

## ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—

### 1. å¯åŠ¨æ•°æ®åº“
```bash
docker-compose up -d
```
è¿™å°†å¯åŠ¨ PostgreSQL å®¹å™¨ï¼Œå¹¶è‡ªåŠ¨æ‰§è¡Œ `init-scripts/init.sql`ã€‚

### 2. éªŒè¯æ•°æ®åº“
```bash
docker exec -it aidemo-pgvector psql -U postgres -d aidemo
# æŸ¥çœ‹è¡¨
\dt
# æŸ¥çœ‹æ‰©å±•
\dx
```

### 3. æµ‹è¯•æ‘„å…¥ (Ingestion)
```bash
curl -X POST http://localhost:8888/ai/knowledge/ingest \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Spring AI ç®€ä»‹",
    "content": "Spring AI æ˜¯ä¸€ä¸ªåº”ç”¨æ¡†æ¶ï¼Œç”¨äºæ„å»ºåŸºäº AI çš„ Java åº”ç”¨...",
    "metadata": {"author": "Zerolg", "version": "1.0"}
  }'
```

### 4. æµ‹è¯•æ£€ç´¢ (Retrieval)
```bash
curl "http://localhost:8888/ai/knowledge/search?query=Spring AI æ˜¯ä»€ä¹ˆ"
```

---

## ğŸ’¡ ä¸‹ä¸€æ­¥è®¡åˆ’

1.  **å®ç°å¼‚æ­¥ ETL**: ç›®å‰æ˜¯åŒæ­¥æ‘„å…¥ï¼Œå¤§æ–‡ä»¶ä¼šé˜»å¡ã€‚éœ€è¦å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚
2.  **æ–‡ä»¶è§£æ**: é›†æˆ Tika è§£æ PDF/Word/Excelã€‚
3.  **æ··åˆæ£€ç´¢**: ç»“åˆ PostgreSQL çš„å…¨æ–‡æ£€ç´¢ (`tsvector`) æå‡å¬å›ç‡ã€‚
4.  **å¤šç§Ÿæˆ·**: åœ¨ `metadata` ä¸­æ·»åŠ  `tenant_id` å¹¶å®ç°è¿‡æ»¤ã€‚

---

**å®æ–½æ—¥æœŸ**: 2025-12-03
**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å°±ç»ª
