<!DOCTYPE html>
<html lang="zh-CN" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Pro Chat</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#131314',
                            surface: '#1e1f20',
                            text: '#e3e3e3'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- Highlight.js -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- Marked (ä½¿ç”¨æ—§ç‰ˆæœ¬é¿å…APIé—®é¢˜) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Light/Dark mode */
        body {
            background: white;
            color: #111;
        }

        body.dark {
            background: #131314;
            color: #e3e3e3;
        }

        /* Markdown */
        .markdown-body {
            font-size: 1rem;
            line-height: 1.6;
        }

        .markdown-body pre {
            background: #f3f4f6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
            position: relative;
        }

        .dark .markdown-body pre {
            background: #282c34;
        }

        .markdown-body code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
        }

        .markdown-body p {
            margin-bottom: 1rem;
        }

        .markdown-body ul,
        .markdown-body ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .markdown-body blockquote {
            border-left: 4px solid #0ea5e9;
            padding-left: 1rem;
            color: #6b7280;
            margin: 1rem 0;
        }

        .dark .markdown-body blockquote {
            color: #9ca3af;
        }

        /* Code copy button */
        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.25rem;
            color: #9ca3af;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            border: none;
        }

        .dark .copy-btn {
            background: rgba(0, 0, 0, 0.3);
        }

        pre:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: rgba(0, 165, 233, 0.2);
            color: #0ea5e9;
        }

        /* Typing cursor */
        .typing-cursor::after {
            content: 'â–‹';
            animation: blink 1s step-start infinite;
            color: #0ea5e9;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .dark ::-webkit-scrollbar-track {
            background: #1e1f20;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d1d1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #b1b1b1;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 8px;
            transition: all 0.3s;
        }

        .status-badge.loading {
            background-color: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .status-badge.success {
            background-color: #ecfdf5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }

        .status-badge.warning {
            background-color: #fffbeb;
            color: #d97706;
            border: 1px solid #fcd34d;
            cursor: help;
        }

        .dark .status-badge.loading {
            background-color: #374151;
            color: #9ca3af;
            border-color: #4b5563;
        }

        .dark .status-badge.success {
            background-color: #064e3b;
            color: #34d399;
            border-color: #059669;
        }

        .dark .status-badge.warning {
            background-color: #78350f;
            color: #fcd34d;
            border-color: #b45309;
        }

        .status-badge.info {
            background-color: #eff6ff;
            color: #3b82f6;
            border: 1px solid #dbeafe;
        }

        .dark .status-badge.info {
            background-color: #1e3a8a;
            color: #93c5fd;
            border-color: #1d4ed8;
        }
    </style>
</head>

<body>
    <div id="app" class="h-screen flex flex-col md:flex-row overflow-hidden">

        <!-- Login Modal -->
        <div v-if="!currentUser"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 dark:bg-black/80 backdrop-blur-sm">
            <div
                class="bg-white dark:bg-[#1e1f20] p-8 rounded-2xl shadow-2xl w-96 border border-gray-200 dark:border-gray-700">
                <div class="text-center mb-8">
                    <h1
                        class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        Gemini Pro</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-2">æ™ºèƒ½ä»“å‚¨åŠ©æ‰‹</p>
                </div>
                <form @submit.prevent="login">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">ç”¨æˆ·å</label>
                        <input v-model="loginForm.username" type="text" required
                            class="w-full bg-gray-50 dark:bg-[#131314] border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            placeholder="è¯·è¾“å…¥æ‚¨çš„åå­—">
                    </div>
                    <button type="submit"
                        class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02]">
                        è¿›å…¥ç³»ç»Ÿ
                    </button>
                </form>
            </div>
        </div>

        <!-- Sidebar -->
        <aside
            :class="['bg-gray-50 dark:bg-[#1e1f20] border-r border-gray-200 dark:border-gray-800 transition-all duration-300 flex flex-col z-20', isSidebarOpen ? 'w-64' : 'w-0 md:w-16']">
            <div class="p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-800">
                <div v-if="isSidebarOpen"
                    class="font-bold text-xl bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent truncate">
                    Gemini Pro
                </div>
                <button @click="toggleSidebar"
                    class="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg text-gray-500 dark:text-gray-400 transition-colors">
                    <i class="ri-menu-line text-xl"></i>
                </button>
            </div>

            <div class="p-3">
                <button @click="startNewChat"
                    class="w-full flex items-center justify-center gap-2 bg-white dark:bg-[#2d2e30] hover:bg-gray-100 dark:hover:bg-[#3c3d40] text-gray-700 dark:text-gray-200 py-3 px-4 rounded-full transition-all border border-gray-200 dark:border-gray-700 shadow-sm group">
                    <i class="ri-add-line text-xl group-hover:rotate-90 transition-transform"></i>
                    <span v-if="isSidebarOpen" class="font-medium">æ–°å¯¹è¯</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                <div v-if="isSidebarOpen" class="text-xs font-semibold text-gray-500 px-3 py-2">æœ€è¿‘å¯¹è¯</div>
                <div v-for="chat in chatHistory" :key="chat.id" @click="loadChat(chat.id)"
                    :class="['group flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors relative', currentChatId === chat.id ? 'bg-blue-50 dark:bg-[#004a77]/30 text-blue-600 dark:text-blue-300' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-[#2d2e30] hover:text-gray-900 dark:hover:text-gray-200']">
                    <i class="ri-message-3-line"></i>
                    <span v-if="isSidebarOpen" class="truncate text-sm">{{ chat.title || 'æ–°å¯¹è¯' }}</span>
                    <button v-if="isSidebarOpen" @click.stop="deleteChat(chat.id)"
                        class="absolute right-2 opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 dark:hover:text-red-400 transition-opacity">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-800 space-y-2">
                <!-- Theme Toggle -->
                <button @click="toggleTheme"
                    class="w-full flex items-center gap-3 p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-[#2d2e30] transition-colors">
                    <i :class="isDarkMode ? 'ri-moon-line' : 'ri-sun-line'"></i>
                    <span v-if="isSidebarOpen" class="text-sm">{{ isDarkMode ? 'æ·±è‰²æ¨¡å¼' : 'æµ…è‰²æ¨¡å¼' }}</span>
                </button>

                <!-- User Info -->
                <div class="flex items-center gap-3 pt-2 border-t border-gray-200 dark:border-gray-800">
                    <div
                        class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xs font-bold text-white">
                        {{ currentUser ? currentUser.charAt(0).toUpperCase() : 'U' }}
                    </div>
                    <div v-if="isSidebarOpen" class="flex-1 min-w-0">
                        <div class="text-sm font-medium truncate text-gray-700 dark:text-gray-200">{{ currentUser }}
                        </div>
                    </div>
                    <button v-if="isSidebarOpen" @click="logout"
                        class="text-gray-500 hover:text-red-500 transition-colors">
                        <i class="ri-logout-box-r-line"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative h-full">
            <!-- Header (Mobile) -->
            <div
                class="md:hidden p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-[#131314]">
                <button @click="toggleSidebar" class="text-gray-500 dark:text-gray-400">
                    <i class="ri-menu-line text-xl"></i>
                </button>
                <span class="font-bold">Gemini Pro</span>
                <div class="w-6"></div>
            </div>

            <!-- Chat Area -->
            <div ref="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
                <div v-if="currentMessages.length === 0"
                    class="h-full flex flex-col items-center justify-center text-center opacity-50">
                    <div
                        class="w-20 h-20 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-full flex items-center justify-center mb-6 animate-pulse-slow">
                        <i class="ri-sparkling-2-fill text-4xl text-blue-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ</h2>
                    <p class="text-gray-500 dark:text-gray-400 max-w-md">æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥è¯¢åº“å­˜ã€è°ƒæ‹¨å•†å“ï¼Œæˆ–è€…å›ç­”å…³äºä»“å‚¨ç®¡ç†çš„ä»»ä½•é—®é¢˜ã€‚</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8 w-full max-w-2xl">
                        <button @click="quickAsk('æŸ¥ä¸€ä¸‹è‹¹æœ15çš„åº“å­˜')"
                            class="p-4 bg-gray-50 dark:bg-[#1e1f20] hover:bg-gray-100 dark:hover:bg-[#2d2e30] rounded-xl text-left transition-colors border border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-600">
                            <i class="ri-search-line text-blue-500 mb-2 block"></i>
                            <span class="text-sm font-medium">æŸ¥ä¸€ä¸‹è‹¹æœ15çš„åº“å­˜</span>
                        </button>
                        <button @click="quickAsk('æŠŠä¸Šæµ·çš„10ä¸ªiPhone 15å‘åˆ°åŒ—äº¬')"
                            class="p-4 bg-gray-50 dark:bg-[#1e1f20] hover:bg-gray-100 dark:hover:bg-[#2d2e30] rounded-xl text-left transition-colors border border-gray-200 dark:border-gray-800 hover:border-gray-300 dark:hover:border-gray-600">
                            <i class="ri-truck-line text-purple-500 mb-2 block"></i>
                            <span class="text-sm font-medium">æŠŠä¸Šæµ·çš„10ä¸ªiPhone 15å‘åˆ°åŒ—äº¬</span>
                        </button>
                    </div>
                </div>

                <div v-for="(msg, index) in currentMessages" :key="index"
                    :class="['flex gap-4 max-w-4xl mx-auto', msg.role === 'user' ? 'flex-row-reverse' : '']">

                    <!-- Avatar -->
                    <div
                        :class="['w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold', 
                        msg.role === 'user' ? 'bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-white' : 'bg-gradient-to-br from-blue-500 to-purple-600 text-white']">
                        <i v-if="msg.role === 'ai'" class="ri-sparkling-2-fill"></i>
                        <span v-else>U</span>
                    </div>

                    <!-- Message Bubble -->
                    <div
                        :class="['max-w-[85%] rounded-2xl px-5 py-3 shadow-sm', 
                        msg.role === 'user' ? 'bg-gray-100 dark:bg-[#2d2e30] text-gray-900 dark:text-white' : 'bg-transparent text-gray-900 dark:text-gray-100']">

                        <!-- Thinking Chain (Collapsible) -->
                        <div v-if="msg.thinking" class="mb-3">
                            <details class="group">
                                <summary
                                    class="flex items-center gap-2 cursor-pointer text-xs font-medium text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors select-none">
                                    <i class="ri-brain-line"></i>
                                    <span>æ€è€ƒè¿‡ç¨‹</span>
                                    <i class="ri-arrow-down-s-line group-open:rotate-180 transition-transform"></i>
                                </summary>
                                <div
                                    class="mt-2 p-3 bg-gray-50 dark:bg-[#1e1f20] rounded-lg border border-gray-200 dark:border-gray-800 text-xs text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap leading-relaxed">
                                    {{ msg.thinking }}
                                </div>
                            </details>
                        </div>

                        <!-- Content -->
                        <div v-if="msg.role === 'ai'" class="markdown-body" v-html="renderMarkdown(msg.content)"></div>
                        <div v-else class="whitespace-pre-wrap">{{ msg.content }}</div>

                        <span v-if="msg.isStreaming" class="typing-cursor"></span>

                        <div :class="['status-badge', msg.verification.status]"
                             :title="msg.verification.reason" v-if="msg.role === 'ai' && msg.verification">
                            <i :class="msg.verification.icon"></i>
                            <span>{{ msg.verification.text }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white dark:bg-[#131314] border-t border-gray-200 dark:border-gray-800">
                <div class="max-w-4xl mx-auto relative">
                    <textarea v-model="inputMessage" @keydown.enter.prevent="handleEnter" rows="1" ref="textarea"
                        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
                        class="w-full bg-gray-100 dark:bg-[#1e1f20] text-gray-900 dark:text-white rounded-2xl pl-4 pr-12 py-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50 resize-none overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700 placeholder-gray-500"
                        style="min-height: 56px; max-height: 200px;"></textarea>

                    <button @click="sendMessage" :disabled="!inputMessage.trim() || isGenerating"
                        class="absolute right-2 bottom-2 p-2 rounded-xl bg-blue-600 dark:bg-white text-white dark:text-black hover:bg-blue-700 dark:hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                        <i v-if="isGenerating" class="ri-stop-circle-line text-xl"></i>
                        <i v-else class="ri-send-plane-fill text-xl"></i>
                    </button>
                </div>
                <div class="text-center text-xs text-gray-500 mt-2">
                    Gemini Pro may display inaccurate info, including about people, so double-check its responses.
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

        // UUIDç”Ÿæˆå‡½æ•°
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Global copy function for code blocks
        window.copyCode = (btn) => {
            const pre = btn.parentElement;
            const code = pre.querySelector('code');
            const text = code.innerText;

            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.innerText;
                btn.innerText = 'å·²å¤åˆ¶!';
                setTimeout(() => {
                    btn.innerText = 'å¤åˆ¶';
                }, 2000);
            });
        };

        createApp({
            setup() {
                // State
                const currentUser = ref(localStorage.getItem('currentUser') || '');
                const loginForm = ref({ username: '' });
                const isSidebarOpen = ref(window.innerWidth > 768);
                const isDarkMode = ref(localStorage.getItem('theme') !== 'light');
                const inputMessage = ref('');
                const isGenerating = ref(false);
                const chatContainer = ref(null);
                const textarea = ref(null);

                // Chat Data
                const chatHistory = ref([]);
                const currentChatId = ref(null);
                const currentChatUUID = ref(null);
                const currentMessages = ref([]);

                // Markdown Setup (ä½¿ç”¨æ—§ç‰ˆAPI)
                marked.setOptions({
                    highlight: function (code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            return hljs.highlight(code, { language: lang }).value;
                        }
                        return hljs.highlightAuto(code).value;
                    },
                    breaks: true
                });

                // Methods
                const renderMarkdown = (text) => {
                    let html = marked.parse(text);
                    // åœ¨æ¸²æŸ“åæ·»åŠ å¤åˆ¶æŒ‰é’®
                    html = html.replace(/<pre><code/g, '<pre><button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button><code');
                    return html;
                };

                const toggleTheme = () => {
                    isDarkMode.value = !isDarkMode.value;
                    updateTheme();
                };

                const updateTheme = () => {
                    if (isDarkMode.value) {
                        document.documentElement.classList.add('dark');
                        document.body.classList.add('dark');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                        document.body.classList.remove('dark');
                        localStorage.setItem('theme', 'light');
                    }
                };

                const login = () => {
                    if (loginForm.value.username.trim()) {
                        currentUser.value = loginForm.value.username;
                        localStorage.setItem('currentUser', currentUser.value);
                        loadHistory();
                    }
                };

                const logout = () => {
                    currentUser.value = '';
                    localStorage.removeItem('currentUser');
                    currentMessages.value = [];
                    currentChatId.value = null;
                    chatHistory.value = [];
                };

                const toggleSidebar = () => {
                    isSidebarOpen.value = !isSidebarOpen.value;
                };

                const getHistoryKey = () => `chatHistory_${currentUser.value}`;

                const loadHistory = () => {
                    const key = getHistoryKey();
                    chatHistory.value = JSON.parse(localStorage.getItem(key) || '[]');
                    if (chatHistory.value.length === 0) {
                        startNewChat();
                    } else {
                        loadChat(chatHistory.value[0].id);
                    }
                };

                const startNewChat = () => {
                    const newChat = {
                        id: Date.now().toString(),
                        uuid: generateUUID(),
                        username: currentUser.value,
                        title: 'æ–°å¯¹è¯',
                        messages: [],
                        timestamp: Date.now()
                    };
                    chatHistory.value.unshift(newChat);
                    saveHistory();
                    loadChat(newChat.id);
                    console.log('ğŸ†• æ–°å¯¹è¯:', { id: newChat.id, uuid: newChat.uuid, user: newChat.username });
                };

                const loadChat = (id) => {
                    currentChatId.value = id;
                    const chat = chatHistory.value.find(c => c.id === id);
                    if (chat) {
                        currentMessages.value = chat.messages;
                        currentChatUUID.value = chat.uuid || null;
                        console.log('ğŸ“‚ åŠ è½½å¯¹è¯:', { id: chat.id, uuid: chat.uuid });
                        nextTick(scrollToBottom);
                    }
                };

                const deleteChat = (id) => {
                    chatHistory.value = chatHistory.value.filter(c => c.id !== id);
                    saveHistory();
                    if (currentChatId.value === id) {
                        if (chatHistory.value.length > 0) {
                            loadChat(chatHistory.value[0].id);
                        } else {
                            startNewChat();
                        }
                    }
                };

                const saveHistory = () => {
                    if (currentUser.value) {
                        localStorage.setItem(getHistoryKey(), JSON.stringify(chatHistory.value));
                    }
                };

                const updateCurrentChat = () => {
                    const chat = chatHistory.value.find(c => c.id === currentChatId.value);
                    if (chat) {
                        chat.messages = currentMessages.value;
                        if (chat.messages.length > 0 && chat.title === 'æ–°å¯¹è¯') {
                            chat.title = chat.messages[0].content.slice(0, 20);
                        }
                        chat.timestamp = Date.now();
                        saveHistory();
                    }
                };

                const scrollToBottom = () => {
                    if (chatContainer.value) {
                        chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                    }
                };

                const autoResizeTextarea = () => {
                    const el = textarea.value;
                    if (el) {
                        el.style.height = 'auto';
                        el.style.height = el.scrollHeight + 'px';
                    }
                };

                watch(inputMessage, () => {
                    nextTick(autoResizeTextarea);
                });

                const handleEnter = (e) => {
                    if (!e.shiftKey) {
                        sendMessage();
                    }
                };

                const quickAsk = (msg) => {
                    inputMessage.value = msg;
                    sendMessage();
                };
                // âœ… æ›¿æ¢ index.html ä¸­çš„ sendMessage æ–¹æ³•
                const sendMessage = () => {
                    const msg = inputMessage.value.trim();
                    if (!msg || isGenerating.value) return;

                    // 1. UI åˆå§‹åŒ–
                    currentMessages.value.push({role: 'user', content: msg, timestamp: Date.now()});
                    inputMessage.value = '';
                    isGenerating.value = true;
                    nextTick(() => {
                        scrollToBottom();
                        autoResizeTextarea();
                    });

                    // 2. AI æ¶ˆæ¯å ä½
                    const aiMsgIndex = currentMessages.value.push({
                        role: 'ai', content: '', isStreaming: true, timestamp: Date.now(),
                        verification: {status: 'loading', icon: 'ri-loader-4-line animate-spin', text: 'æ­£åœ¨éªŒè¯...'}
                    }) - 1;

                    // 3. å»ºç«‹è¿æ¥
                    const url = `http://localhost:8888/three-stage/stream?chatId=${currentChatId.value}&msg=${encodeURIComponent(msg)}`;
                    console.log("å‘èµ·è¯·æ±‚:", url);
                    let eventSource = new EventSource(url);

                    // ğŸ”¥ é˜²é‡è¿é”ï¼šç¡®ä¿ close åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸”å½»åº•
                    let isClosed = false;
                    const forceClose = () => {
                        if (isClosed) return;
                        isClosed = true;
                        console.log("ğŸ›‘ å¼ºåˆ¶å…³é—­è¿æ¥");
                        eventSource.close();
                        eventSource = null; // é”€æ¯å¯¹è±¡
                        finalizeMessage(aiMsgIndex);
                    };

                    // ç›‘å¬æ¶ˆæ¯
                    eventSource.addEventListener('message', (e) => {
                        if (isClosed) return; // å¦‚æœå·²å…³é—­ï¼Œä¸¢å¼ƒåç»­åŒ…
                        currentMessages.value[aiMsgIndex].content += e.data;
                        nextTick(scrollToBottom);
                    });

                    // ç›‘å¬éªŒè¯ç»“æœ
                    eventSource.addEventListener('verification', (e) => {
                        if (isClosed) return;
                        console.log("æ”¶åˆ°éªŒè¯ç»“æœ:", e.data);

                        const result = JSON.parse(e.data);
                        const aiMsg = currentMessages.value[aiMsgIndex];

                        if (result.passed) {
                            // âœ… ä¿®å¤ï¼šå®½æ¾åˆ¤æ–­ 0.5 (é˜²æ­¢æµ®ç‚¹æ•°å·®å¼‚)
                            if (result.confidence <= 0.55) {
                                aiMsg.verification = {
                                    status: 'info', // è“è‰²
                                    icon: 'ri-lightbulb-flash-line',
                                    text: 'é€šç”¨çŸ¥è¯† (æ— æ–‡æ¡£ä¾æ®)'
                                };
                            } else {
                                aiMsg.verification = {
                                    status: 'success', // ç»¿è‰²
                                    icon: 'ri-shield-check-fill',
                                    text: `æ¥æºå¯ä¿¡ (${(result.confidence * 100).toFixed(0)}%)`
                                };
                            }
                        } else {
                            aiMsg.verification = {
                                status: 'warning', // é»„è‰²
                                icon: 'ri-alert-fill',
                                text: 'å†…å®¹å­˜ç–‘',
                                reason: result.reason
                            };
                        }

                        // æ”¶åˆ°éªŒè¯ç»“æœï¼Œè§†ä¸ºæ­£å¸¸ç»“æŸ -> å…³ï¼
                        forceClose();
                    });

                    // ç›‘å¬é”™è¯¯ (åŒ…æ‹¬æ­£å¸¸çš„ EOF)
                    eventSource.onerror = (e) => {
                        // SSE æ ‡å‡†ï¼šè¿æ¥ç»“æŸä¹Ÿä¼šè§¦å‘ onerror
                        console.log("è¿æ¥ç»“æŸæˆ–å¼‚å¸¸", e);

                        const aiMsg = currentMessages.value[aiMsgIndex];
                        // å¦‚æœæ–­å¼€æ—¶è¿˜åœ¨ loadingï¼Œè¯´æ˜å‡ºé”™äº†æ²¡æ‹¿åˆ°ç»“æœ
                        if (aiMsg.verification && aiMsg.verification.status === 'loading') {
                            aiMsg.verification = null;
                        }

                        // åªè¦è§¦å‘ onerrorï¼Œç«‹åˆ»å…³ï¼ç»ä¸é‡è¯•ï¼
                        forceClose();
                    };
                };


                // Init
                onMounted(() => {
                    updateTheme();
                    if (currentUser.value) {
                        loadHistory();
                    }
                });

                // è·å–å½“å‰UUID
                const getCurrentChatUUID = () => currentChatUUID.value;
                window.getCurrentChatUUID = getCurrentChatUUID;

                return {
                    currentUser,
                    loginForm,
                    isSidebarOpen,
                    isDarkMode,
                    inputMessage,
                    isGenerating,
                    chatContainer,
                    textarea,
                    chatHistory,
                    currentChatId,
                    currentChatUUID,
                    currentMessages,
                    login,
                    logout,
                    toggleSidebar,
                    toggleTheme,
                    startNewChat,
                    loadChat,
                    deleteChat,
                    renderMarkdown,
                    handleEnter,
                    sendMessage,
                    quickAsk,
                    getCurrentChatUUID
                };
            }
        }).mount('#app');
    </script>
</body>

</html>